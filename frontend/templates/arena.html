<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARENA // COMBAT TRAINING</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050508;
            --bg-panel: #0a0a0f;
            --border: #1a1a2a;
            --text: #c0c0c0;
            --green: #00ff41;
            --red: #ff3333;
            --amber: #ffaa00;
            --blue: #00aaff;
            --purple: #aa00ff;
            --cyan: #00d9ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(170, 0, 255, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 0, 100, 0.03) 0%, transparent 50%);
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, var(--bg-panel), transparent);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--red);
            font-size: 1.8rem;
            text-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
            letter-spacing: 3px;
        }

        .back-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .back-btn:hover {
            border-color: var(--cyan);
            color: var(--cyan);
        }

        /* Main Layout */
        .container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 0;
            height: calc(100vh - 80px);
        }

        /* Left Sidebar - Mode Selection */
        .sidebar {
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .mode-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            color: var(--amber);
            letter-spacing: 2px;
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        /* Mode Cards */
        .mode-card {
            background: linear-gradient(135deg, #0f0f18, #0a0a12);
            border: 1px solid var(--border);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 4px;
        }

        .mode-card:hover {
            border-color: var(--purple);
            transform: translateX(5px);
        }

        .mode-card.selected {
            border-color: var(--cyan);
            background: linear-gradient(135deg, #0a1520, #0a0a12);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.1);
        }

        .mode-card .icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .mode-card .title {
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.25rem;
        }

        .mode-card .desc {
            font-size: 0.75rem;
            color: #666;
        }

        /* Trauma List */
        .trauma-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .trauma-item {
            background: #080810;
            border: 1px solid var(--border);
            border-left: 3px solid var(--red);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trauma-item:hover {
            background: #0c0c14;
            border-left-color: var(--amber);
        }

        .trauma-item.selected {
            border-left-color: var(--cyan);
            background: #0a1015;
        }

        .trauma-item.healed {
            opacity: 0.4;
            border-left-color: #003300;
        }

        .trauma-id {
            font-size: 0.7rem;
            color: var(--amber);
        }

        .trauma-desc {
            font-size: 0.8rem;
            margin: 0.25rem 0;
            color: #aaa;
        }

        .trauma-severity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
        }

        .severity-bar {
            flex: 1;
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
        }

        .severity-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--amber), var(--red));
            border-radius: 2px;
        }

        /* Start Button */
        .action-area {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .start-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #1a0a0a, #0a0a0a);
            border: 2px solid var(--red);
            color: var(--red);
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .start-btn:hover {
            background: var(--red);
            color: #000;
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.5);
        }

        .start-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .start-btn.running {
            background: var(--amber);
            border-color: var(--amber);
            color: #000;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(255, 170, 0, 0.3);
            }

            50% {
                box-shadow: 0 0 40px rgba(255, 170, 0, 0.6);
            }
        }

        /* Main Content - Terminal */
        .main-content {
            display: flex;
            flex-direction: column;
            background: #030306;
        }

        /* Combatants Header */
        .combatants {
            display: flex;
            justify-content: center;
            gap: 4rem;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #0a0a0f, transparent);
        }

        .combatant {
            text-align: center;
        }

        .combatant .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin: 0 auto 0.5rem;
        }

        .combatant.red .avatar {
            background: linear-gradient(135deg, #330000, #1a0000);
            border: 2px solid var(--red);
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.3);
        }

        .combatant.blue .avatar {
            background: linear-gradient(135deg, #000033, #00001a);
            border: 2px solid var(--blue);
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.3);
        }

        .combatant .name {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .combatant.red .name {
            color: var(--red);
        }

        .combatant.blue .name {
            color: var(--blue);
        }

        .combatant .role {
            font-size: 0.7rem;
            color: #555;
            text-transform: uppercase;
        }

        .vs {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--purple);
            align-self: center;
            text-shadow: 0 0 10px var(--purple);
        }

        /* Terminal */
        .terminal {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #080810;
            border-bottom: 1px solid var(--border);
        }

        .terminal-title {
            font-size: 0.75rem;
            color: var(--green);
            letter-spacing: 1px;
        }

        .terminal-stats {
            display: flex;
            gap: 1.5rem;
            font-size: 0.7rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-label {
            color: #555;
        }

        .stat-value {
            color: var(--cyan);
            font-weight: 700;
        }

        .terminal-output {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            font-size: 0.8rem;
            line-height: 1.6;
        }

        .terminal-output::-webkit-scrollbar {
            width: 6px;
        }

        .terminal-output::-webkit-scrollbar-thumb {
            background: var(--border);
        }

        .log-entry {
            padding: 0.25rem 0;
            border-left: 2px solid transparent;
            padding-left: 0.75rem;
            margin-left: -0.75rem;
        }

        .log-entry .time {
            color: #333;
            font-size: 0.7rem;
            margin-right: 0.5rem;
        }

        .log-entry.RED {
            border-left-color: var(--green);
            color: var(--green);
        }

        .log-entry.BLUE {
            border-left-color: var(--blue);
            color: var(--blue);
        }

        .log-entry.SYSTEM {
            color: var(--amber);
        }

        .log-entry.ERROR {
            color: var(--red);
            background: rgba(255, 0, 0, 0.05);
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        .status-dot.idle {
            background: #555;
        }

        .status-dot.running {
            background: var(--amber);
            animation: blink 0.5s infinite;
        }

        .status-dot.success {
            background: var(--green);
        }

        .status-dot.error {
            background: var(--red);
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* Psyche Meters */
        .psyche-meters {
            display: flex;
            gap: 2rem;
        }

        .meter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .meter-label {
            font-size: 0.7rem;
            color: #555;
            width: 60px;
        }

        .meter-bar {
            width: 100px;
            height: 6px;
            background: #1a1a1a;
            border-radius: 3px;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            transition: width 0.5s;
        }

        .meter-fill.dopamine {
            background: linear-gradient(90deg, #004400, var(--green));
        }

        .meter-fill.cortisol {
            background: linear-gradient(90deg, #440000, var(--red));
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #333;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state .text {
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>‚öîÔ∏è ARENA</h1>
        <button class="back-btn" onclick="window.location='/'">‚Üê BACK TO OPS</button>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="mode-section">
                <div class="section-title">Combat Mode</div>

                <div class="mode-card selected" data-mode="freestyle" onclick="selectMode('freestyle')">
                    <div class="icon">üé≤</div>
                    <div class="title">Freestyle</div>
                    <div class="desc">Open combat - no specific objective</div>
                </div>

                <div class="mode-card" data-mode="therapy" onclick="selectMode('therapy')">
                    <div class="icon">ü©π</div>
                    <div class="title">Trauma Therapy</div>
                    <div class="desc">Train against recorded failures</div>
                </div>

                <div class="mode-card" data-mode="challenge" onclick="selectMode('challenge')">
                    <div class="icon">üèÜ</div>
                    <div class="title">Challenge</div>
                    <div class="desc">Timed objective scenarios</div>
                </div>
            </div>

            <div class="section-title" style="padding: 1rem 1.5rem 0;">Active Traumas</div>
            <div class="trauma-list" id="traumaList">
                <!-- Populated by JS -->
            </div>

            <div class="action-area">
                <button class="start-btn" id="startBtn" onclick="startCombat()">
                    ‚ö° INITIATE
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="combatants">
                <div class="combatant red">
                    <div class="avatar">üî¥</div>
                    <div class="name">BATOU</div>
                    <div class="role">Red Team</div>
                </div>
                <div class="vs">VS</div>
                <div class="combatant blue">
                    <div class="avatar">üîµ</div>
                    <div class="name">TOGUSA</div>
                    <div class="role">Blue Team</div>
                </div>
            </div>

            <div class="terminal">
                <div class="terminal-header">
                    <div class="terminal-title">‚ñ∂ COMBAT LOG</div>
                    <div class="terminal-stats">
                        <div class="stat">
                            <span class="stat-label">ROUND</span>
                            <span class="stat-value" id="roundNum">--</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">DURATION</span>
                            <span class="stat-value" id="duration">00:00</span>
                        </div>
                    </div>
                </div>

                <div class="terminal-output" id="terminalOutput">
                    <div class="empty-state">
                        <div class="icon">‚öîÔ∏è</div>
                        <div class="text">Select mode and initiate combat</div>
                    </div>
                </div>
            </div>

            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot idle" id="statusDot"></div>
                    <span id="statusText">STANDBY</span>
                </div>
                <div class="psyche-meters">
                    <div class="meter">
                        <span class="meter-label">Dopamine</span>
                        <div class="meter-bar">
                            <div class="meter-fill dopamine" id="dopamineBar" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="meter">
                        <span class="meter-label">Cortisol</span>
                        <div class="meter-bar">
                            <div class="meter-fill cortisol" id="cortisolBar" style="width: 30%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedMode = 'freestyle';
        let selectedTraumaId = null;
        let eventSource = null;
        let startTime = null;
        let timerInterval = null;

        // Mode Selection
        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.mode === mode);
            });

            // Show/hide trauma list based on mode
            const traumaSection = document.querySelector('.trauma-list');
            if (mode === 'therapy') {
                traumaSection.style.display = 'block';
                loadTraumas();
            } else {
                traumaSection.style.display = mode === 'freestyle' ? 'none' : 'block';
            }
        }

        // Load Traumas
        async function loadTraumas() {
            try {
                const res = await fetch('/arena/traumas');
                const data = await res.json();
                renderTraumas(data.traumas || []);
            } catch (e) {
                console.error('Failed to load traumas:', e);
            }
        }

        function renderTraumas(traumas) {
            const list = document.getElementById('traumaList');
            const unresolved = traumas.filter(t => t.status !== 'HEALED');

            if (!unresolved.length) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #333;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üß†</div>
                        <div style="font-size: 0.8rem;">No traumas recorded</div>
                    </div>`;
                return;
            }

            list.innerHTML = unresolved.map(t => `
                <div class="trauma-item ${t.status === 'HEALED' ? 'healed' : ''}" 
                     data-id="${t.trauma_id}"
                     onclick="selectTrauma('${t.trauma_id}')">
                    <div class="trauma-id">${t.trauma_id}</div>
                    <div class="trauma-desc">${t.description}</div>
                    <div class="trauma-severity">
                        <div class="severity-bar">
                            <div class="severity-fill" style="width: ${t.severity * 100}%"></div>
                        </div>
                        <span style="color: ${t.severity > 0.7 ? '#ff3333' : '#ffaa00'}">${(t.severity * 100).toFixed(0)}%</span>
                    </div>
                </div>
            `).join('');
        }

        function selectTrauma(id) {
            selectedTraumaId = id;
            document.querySelectorAll('.trauma-item').forEach(el => {
                el.classList.toggle('selected', el.dataset.id === id);
            });
        }

        // Start Combat
        async function startCombat() {
            const btn = document.getElementById('startBtn');

            if (btn.classList.contains('running')) {
                // Stop
                if (eventSource) eventSource.close();
                btn.classList.remove('running');
                btn.textContent = '‚ö° INITIATE';
                setStatus('idle', 'STANDBY');
                return;
            }

            // Clear terminal
            document.getElementById('terminalOutput').innerHTML = '';

            btn.classList.add('running');
            btn.textContent = '‚ñ† ABORT';
            setStatus('running', 'COMBAT ACTIVE');

            // Start timer
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            try {
                if (selectedMode === 'therapy' && selectedTraumaId) {
                    // Therapy mode - use trauma
                    await fetch('/arena/start_therapy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ trauma_id: selectedTraumaId })
                    });
                    connectStream('/arena/stream');
                } else {
                    // Freestyle mode - use standard arena
                    await fetch('/api/arena/start', { method: 'POST' });
                    connectStream('/api/arena/stream');
                }
            } catch (e) {
                addLog('Connection error: ' + e.message, 'ERROR');
                stopCombat();
            }
        }

        function connectStream(endpoint) {
            if (eventSource) eventSource.close();

            eventSource = new EventSource(endpoint);

            eventSource.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    if (data.message) {
                        addLog(data.message, data.level || 'INFO');
                    }
                    if (data.type === 'log') {
                        addLog(data.message, 'SYSTEM');
                    }
                    if (data.psyche) updatePsyche(data.psyche);
                } catch {
                    if (e.data && e.data !== '{"type":"heartbeat"}') {
                        addLog(e.data, 'INFO');
                    }
                }
            };

            eventSource.onerror = () => {
                stopCombat();
            };
        }

        function stopCombat() {
            if (eventSource) eventSource.close();
            if (timerInterval) clearInterval(timerInterval);

            const btn = document.getElementById('startBtn');
            btn.classList.remove('running');
            btn.textContent = '‚ö° INITIATE';
            setStatus('idle', 'COMPLETE');
        }

        function addLog(message, level = 'INFO') {
            const output = document.getElementById('terminalOutput');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });

            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            entry.innerHTML = `<span class="time">[${time}]</span>${message}`;

            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        function setStatus(state, text) {
            const dot = document.getElementById('statusDot');
            dot.className = `status-dot ${state}`;
            document.getElementById('statusText').textContent = text;
        }

        function updateTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('duration').textContent = `${mins}:${secs}`;
        }

        function updatePsyche(psyche) {
            if (psyche.dopamine !== undefined) {
                document.getElementById('dopamineBar').style.width = (psyche.dopamine * 100) + '%';
            }
            if (psyche.cortisol !== undefined) {
                document.getElementById('cortisolBar').style.width = (psyche.cortisol * 100) + '%';
            }
        }

        // Fetch psyche state
        async function loadPsyche() {
            try {
                const res = await fetch('/api/psyche/state');
                const data = await res.json();
                updatePsyche(data);
            } catch (e) { }
        }

        // Initial load
        loadTraumas();
        loadPsyche();
        setInterval(loadPsyche, 5000);
    </script>
</body>

</html>