#!/usr/bin/env python3
"""
Exploit-DB Source - Integrazione Exploit-DB
"""
import requests
from bs4 import BeautifulSoup
from typing import List, Dict, Optional
from datetime import datetime, timedelta
from .base import DataSource, SourceResult

class ExploitDBSource(DataSource):
    """Source per Exploit-DB"""
    
    BASE_URL = 'https://www.exploit-db.com'
    RSS_URL = 'https://www.exploit-db.com/rss.xml'
    
    def __init__(self, enabled: bool = True):
        super().__init__('exploitdb', enabled)
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'KaliAI-ExploitDB/1.0'
        })
    
    def fetch(self, days: int = 7, max_items: int = 50) -> List[SourceResult]:
        """
        Fetcha exploit da Exploit-DB RSS.
        
        Args:
            days: Numero di giorni da cercare
            max_items: Numero massimo di exploit
        """
        if not self.enabled:
            return []
        
        results = []
        
        try:
            import feedparser
            
            feed = feedparser.parse(self.RSS_URL)
            
            cutoff_date = datetime.now() - timedelta(days=days)
            
            for entry in feed.entries[:max_items]:
                # Estrai data
                pub_date = None
                if hasattr(entry, 'published_parsed') and entry.published_parsed:
                    pub_date = datetime(*entry.published_parsed[:6])
                
                if pub_date and pub_date < cutoff_date:
                    continue
                
                title = entry.get('title', 'No title')
                summary = entry.get('summary', '')
                link = entry.get('link', '')
                
                # Estrai EDB-ID
                edb_id = None
                if '/exploits/' in link:
                    edb_id = link.split('/exploits/')[-1].split('/')[0]
                
                # Estrai CVE se presente
                cves = []
                if 'CVE-' in title or 'CVE-' in summary:
                    import re
                    cves = re.findall(r'CVE-\d{4}-\d+', title + ' ' + summary)
                
                content = f"""
Exploit-DB: {title}

EDB-ID: {edb_id or 'N/A'}

DESCRIPTION:
{summary[:500]}

CVEs: {', '.join(set(cves)) if cves else 'None'}

LINK: {link}
"""
                
                relevance = 0.9 if cves else 0.8
                
                results.append(SourceResult(
                    title=title,
                    content=content.strip(),
                    source_type='exploit',
                    source_name='exploitdb',
                    url=link,
                    metadata={
                        'edb_id': edb_id,
                        'cves': list(set(cves)),
                        'published': pub_date.isoformat() if pub_date else None
                    },
                    timestamp=pub_date or datetime.now(),
                    relevance_score=relevance
                ))
            
            self.fetch_count += 1
            self.last_fetch = datetime.now()
            
        except Exception as e:
            self.error_count += 1
            print(f"[Exploit-DB] Errore fetch: {e}")
        
        return results
    
    def get_source_info(self) -> Dict:
        """Info sul source"""
        return {
            'name': self.name,
            'type': 'exploit_database',
            'url': self.BASE_URL,
            'description': 'Exploit-DB exploit database',
            'rate_limit': 'None',
            'requires_auth': False
        }

